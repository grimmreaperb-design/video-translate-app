<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Room ID - Video Translate App</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .section h2 {
            color: #FFD700;
            margin-top: 0;
            font-size: 1.5em;
        }
        .log-area {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: rgba(76, 175, 80, 0.3); }
        .status.error { background: rgba(244, 67, 54, 0.3); }
        .status.warning { background: rgba(255, 193, 7, 0.3); }
        .status.info { background: rgba(33, 150, 243, 0.3); }
        button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        input {
            padding: 10px;
            border: none;
            border-radius: 8px;
            margin: 5px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .test-result {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 5px solid;
        }
        .test-result.pass {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
        }
        .test-result.fail {
            background: rgba(244, 67, 54, 0.2);
            border-color: #f44336;
        }
        .url-display {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Room ID - Diagn√≥stico Completo</h1>
        
        <div class="section">
            <h2>üìä Informa√ß√µes da URL Atual</h2>
            <div id="urlInfo"></div>
        </div>

        <div class="section">
            <h2>üß™ Teste de Parsing de Room ID</h2>
            <input type="text" id="testUrl" placeholder="Cole uma URL para testar" style="width: 70%;">
            <button onclick="testUrlParsing()">Testar Parsing</button>
            <div id="parsingResults"></div>
        </div>

        <div class="grid">
            <div class="section">
                <h2>üîó Teste de Conex√£o Socket.IO</h2>
                <button onclick="testSocketConnection()">Testar Conex√£o</button>
                <div id="socketStatus"></div>
                <div class="log-area" id="socketLogs"></div>
            </div>

            <div class="section">
                <h2>üè† Teste de Join Room</h2>
                <input type="text" id="testRoomId" placeholder="Room ID para testar" value="test-123">
                <input type="text" id="testUserName" placeholder="Nome do usu√°rio" value="TestUser">
                <button onclick="testJoinRoom()">Entrar na Sala</button>
                <div id="roomStatus"></div>
                <div class="log-area" id="roomLogs"></div>
            </div>
        </div>

        <div class="section">
            <h2>üîÑ Teste de M√∫ltiplas Conex√µes</h2>
            <button onclick="testMultipleConnections()">Simular 2 Usu√°rios</button>
            <div id="multiConnectionStatus"></div>
            <div class="log-area" id="multiConnectionLogs"></div>
        </div>

        <div class="section">
            <h2>üìã Resultados dos Testes</h2>
            <div id="testResults"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const BACKEND_URL = 'https://video-translate-app-backend.onrender.com';
        let testSocket = null;
        let testSocket2 = null;
        let testResults = [];

        function log(message, area = 'socketLogs', type = 'info') {
            const logArea = document.getElementById(area);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logArea.textContent += logEntry;
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function addTestResult(test, passed, details) {
            testResults.push({ test, passed, details, timestamp: new Date() });
            updateTestResults();
        }

        function updateTestResults() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = testResults.map(result => `
                <div class="test-result ${result.passed ? 'pass' : 'fail'}">
                    <strong>${result.passed ? '‚úÖ' : '‚ùå'} ${result.test}</strong><br>
                    <small>${result.details}</small><br>
                    <small>‚è∞ ${result.timestamp.toLocaleTimeString()}</small>
                </div>
            `).join('');
        }

        function displayUrlInfo() {
            const urlInfo = document.getElementById('urlInfo');
            const currentUrl = window.location.href;
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('roomId');
            
            urlInfo.innerHTML = `
                <div class="url-display">
                    <strong>URL Completa:</strong> ${currentUrl}
                </div>
                <div class="status ${roomId ? 'success' : 'warning'}">
                    <strong>Room ID:</strong> ${roomId || 'N√£o encontrado'}
                </div>
                <div class="status info">
                    <strong>Par√¢metros:</strong> ${window.location.search || 'Nenhum'}
                </div>
            `;

            // Teste autom√°tico do parsing
            if (roomId) {
                addTestResult('URL Parsing', true, `Room ID "${roomId}" extra√≠do com sucesso`);
            } else {
                addTestResult('URL Parsing', false, 'Nenhum Room ID encontrado na URL');
            }
        }

        function testUrlParsing() {
            const testUrl = document.getElementById('testUrl').value;
            const resultsDiv = document.getElementById('parsingResults');
            
            if (!testUrl) {
                resultsDiv.innerHTML = '<div class="status error">Por favor, insira uma URL para testar</div>';
                return;
            }

            try {
                const url = new URL(testUrl);
                const params = new URLSearchParams(url.search);
                const roomId = params.get('roomId');
                
                resultsDiv.innerHTML = `
                    <div class="status ${roomId ? 'success' : 'warning'}">
                        <strong>URL:</strong> ${testUrl}<br>
                        <strong>Room ID:</strong> ${roomId || 'N√£o encontrado'}<br>
                        <strong>Search:</strong> ${url.search || 'Vazio'}
                    </div>
                `;

                addTestResult('URL Parsing Manual', !!roomId, `URL: ${testUrl}, Room ID: ${roomId || 'n√£o encontrado'}`);
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">Erro ao analisar URL: ${error.message}</div>`;
                addTestResult('URL Parsing Manual', false, `Erro: ${error.message}`);
            }
        }

        function testSocketConnection() {
            const statusDiv = document.getElementById('socketStatus');
            statusDiv.innerHTML = '<div class="status info">Conectando...</div>';
            log('üîå Iniciando teste de conex√£o Socket.IO...', 'socketLogs');

            if (testSocket) {
                testSocket.disconnect();
            }

            testSocket = io(BACKEND_URL, {
                transports: ['websocket', 'polling'],
                timeout: 10000
            });

            testSocket.on('connect', () => {
                statusDiv.innerHTML = '<div class="status success">‚úÖ Conectado com sucesso!</div>';
                log('‚úÖ Socket conectado com sucesso', 'socketLogs');
                addTestResult('Conex√£o Socket.IO', true, `Conectado ao ${BACKEND_URL}`);
            });

            testSocket.on('disconnect', (reason) => {
                statusDiv.innerHTML = `<div class="status warning">‚ö†Ô∏è Desconectado: ${reason}</div>`;
                log(`‚ö†Ô∏è Socket desconectado: ${reason}`, 'socketLogs');
            });

            testSocket.on('connect_error', (error) => {
                statusDiv.innerHTML = `<div class="status error">‚ùå Erro de conex√£o: ${error.message}</div>`;
                log(`‚ùå Erro de conex√£o: ${error.message}`, 'socketLogs');
                addTestResult('Conex√£o Socket.IO', false, `Erro: ${error.message}`);
            });
        }

        function testJoinRoom() {
            const roomId = document.getElementById('testRoomId').value;
            const userName = document.getElementById('testUserName').value;
            const statusDiv = document.getElementById('roomStatus');

            if (!roomId || !userName) {
                statusDiv.innerHTML = '<div class="status error">Por favor, preencha Room ID e Nome</div>';
                return;
            }

            if (!testSocket || !testSocket.connected) {
                statusDiv.innerHTML = '<div class="status error">Socket n√£o conectado. Teste a conex√£o primeiro.</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="status info">Entrando na sala...</div>';
            log(`üè† Tentando entrar na sala: ${roomId} como ${userName}`, 'roomLogs');

            const userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            // Listeners para eventos da sala
            testSocket.on('room-users', (users) => {
                log(`üë• Usu√°rios na sala: ${JSON.stringify(users)}`, 'roomLogs');
                statusDiv.innerHTML = `<div class="status success">‚úÖ Na sala com ${users.length} usu√°rio(s)</div>`;
                addTestResult('Join Room', true, `Entrou na sala ${roomId} com ${users.length} usu√°rio(s)`);
            });

            testSocket.on('user-joined', (user) => {
                log(`üë§ Usu√°rio entrou: ${JSON.stringify(user)}`, 'roomLogs');
            });

            testSocket.on('user-left', (userIdLeft) => {
                log(`üëã Usu√°rio saiu: ${userIdLeft}`, 'roomLogs');
            });

            // Entrar na sala
            testSocket.emit('join-room', {
                roomId: roomId,
                user: {
                    id: userId,
                    name: userName
                }
            });

            log(`üì§ Evento join-room enviado: roomId=${roomId}, userId=${userId}, userName=${userName}`, 'roomLogs');
        }

        function testMultipleConnections() {
            const statusDiv = document.getElementById('multiConnectionStatus');
            const roomId = 'multi-test-' + Date.now();
            
            statusDiv.innerHTML = '<div class="status info">Criando m√∫ltiplas conex√µes...</div>';
            log(`üîÑ Iniciando teste com m√∫ltiplas conex√µes na sala: ${roomId}`, 'multiConnectionLogs');

            // Limpar conex√µes anteriores
            if (testSocket2) testSocket2.disconnect();

            // Criar duas conex√µes
            const socket1 = io(BACKEND_URL, { transports: ['websocket', 'polling'] });
            const socket2 = io(BACKEND_URL, { transports: ['websocket', 'polling'] });

            let socket1Connected = false;
            let socket2Connected = false;
            let socket1InRoom = false;
            let socket2InRoom = false;

            function checkCompletion() {
                if (socket1Connected && socket2Connected && socket1InRoom && socket2InRoom) {
                    statusDiv.innerHTML = '<div class="status success">‚úÖ Ambos usu√°rios conectados na mesma sala!</div>';
                    addTestResult('M√∫ltiplas Conex√µes', true, `Dois usu√°rios na sala ${roomId}`);
                }
            }

            // Socket 1
            socket1.on('connect', () => {
                socket1Connected = true;
                log('‚úÖ Socket 1 conectado', 'multiConnectionLogs');
                
                socket1.emit('join-room', {
                    roomId: roomId,
                    user: { id: 'user1_' + Date.now(), name: 'Alice' }
                });
            });

            socket1.on('room-users', (users) => {
                socket1InRoom = true;
                log(`üë• Socket 1 - Usu√°rios na sala: ${users.length}`, 'multiConnectionLogs');
                checkCompletion();
            });

            // Socket 2
            socket2.on('connect', () => {
                socket2Connected = true;
                log('‚úÖ Socket 2 conectado', 'multiConnectionLogs');
                
                // Aguardar um pouco antes de entrar
                setTimeout(() => {
                    socket2.emit('join-room', {
                        roomId: roomId,
                        user: { id: 'user2_' + Date.now(), name: 'Bob' }
                    });
                }, 1000);
            });

            socket2.on('room-users', (users) => {
                socket2InRoom = true;
                log(`üë• Socket 2 - Usu√°rios na sala: ${users.length}`, 'multiConnectionLogs');
                checkCompletion();
            });

            // Eventos de erro
            socket1.on('connect_error', (error) => {
                log(`‚ùå Socket 1 erro: ${error.message}`, 'multiConnectionLogs');
                addTestResult('M√∫ltiplas Conex√µes', false, `Socket 1 erro: ${error.message}`);
            });

            socket2.on('connect_error', (error) => {
                log(`‚ùå Socket 2 erro: ${error.message}`, 'multiConnectionLogs');
                addTestResult('M√∫ltiplas Conex√µes', false, `Socket 2 erro: ${error.message}`);
            });

            // Limpar ap√≥s 30 segundos
            setTimeout(() => {
                socket1.disconnect();
                socket2.disconnect();
                log('üßπ Conex√µes de teste limpas', 'multiConnectionLogs');
            }, 30000);
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            displayUrlInfo();
            
            // Auto-testar se h√° roomId na URL
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('roomId');
            if (roomId) {
                document.getElementById('testRoomId').value = roomId;
                log(`üéØ Room ID detectado na URL: ${roomId}`, 'socketLogs');
            }
        });
    </script>
</body>
</html>