<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Problema de Salas Separadas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        .error-section {
            background: #fff5f5;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #dc3545;
        }
        .success-section {
            background: #f0fff4;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        .test-result {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .step {
            background: #e3f2fd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug - Problema de Salas Separadas</h1>
        
        <div class="debug-section">
            <h3>üéØ Objetivo</h3>
            <p>Identificar por que usu√°rios est√£o entrando em salas separadas em vez da mesma sala.</p>
        </div>

        <div class="step">
            <h3>üìã Passo 1: Verificar Gera√ß√£o de Room ID</h3>
            <button onclick="testRoomIdGeneration()">üß™ Testar Gera√ß√£o de Room ID</button>
            <div id="roomIdTest" class="test-result"></div>
        </div>

        <div class="step">
            <h3>üìã Passo 2: Verificar URL Parsing</h3>
            <button onclick="testUrlParsing()">üß™ Testar Parsing de URL</button>
            <div id="urlParsingTest" class="test-result"></div>
        </div>

        <div class="step">
            <h3>üìã Passo 3: Simular Cen√°rio Real</h3>
            <button onclick="simulateRealScenario()">üß™ Simular Cen√°rio Real</button>
            <div id="realScenarioTest" class="test-result"></div>
        </div>

        <div class="step">
            <h3>üìã Passo 4: Teste de Conex√£o Backend</h3>
            <button onclick="testBackendConnection()">üß™ Testar Conex√£o Backend</button>
            <div id="backendTest" class="test-result"></div>
        </div>

        <div class="step">
            <h3>üìã Passo 5: Teste Completo</h3>
            <button onclick="runCompleteTest()">üöÄ Executar Teste Completo</button>
            <div id="completeTest" class="test-result"></div>
        </div>

        <div class="debug-section">
            <h3>üîß Poss√≠veis Causas Identificadas</h3>
            <ul id="possibleCauses">
                <li>Aguardando testes...</li>
            </ul>
        </div>

        <div class="success-section" id="solution" style="display: none;">
            <h3>‚úÖ Solu√ß√£o Encontrada</h3>
            <div id="solutionText"></div>
        </div>
    </div>

    <script>
        function log(elementId, message) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent += `[${timestamp}] ${message}\n`;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).textContent = '';
        }

        function testRoomIdGeneration() {
            clearLog('roomIdTest');
            log('roomIdTest', 'üß™ Testando gera√ß√£o de Room ID...');
            
            // Simula como o frontend gera room IDs
            const urlParams = new URLSearchParams(window.location.search);
            const roomIdFromUrl = urlParams.get('roomId');
            
            log('roomIdTest', `URL atual: ${window.location.href}`);
            log('roomIdTest', `Room ID da URL: ${roomIdFromUrl || 'Nenhum'}`);
            
            if (!roomIdFromUrl) {
                // Simula gera√ß√£o de novo room ID
                const newRoomId = Math.random().toString(36).substr(2, 9);
                log('roomIdTest', `Novo Room ID gerado: ${newRoomId}`);
                log('roomIdTest', `Nova URL seria: ${window.location.origin}?roomId=${newRoomId}`);
            }
            
            // Testa m√∫ltiplas gera√ß√µes
            log('roomIdTest', '\nüîÑ Testando m√∫ltiplas gera√ß√µes:');
            for (let i = 0; i < 5; i++) {
                const id = Math.random().toString(36).substr(2, 9);
                log('roomIdTest', `Gera√ß√£o ${i + 1}: ${id}`);
            }
            
            log('roomIdTest', '\n‚úÖ Teste de gera√ß√£o conclu√≠do');
        }

        function testUrlParsing() {
            clearLog('urlParsingTest');
            log('urlParsingTest', 'üß™ Testando parsing de URL...');
            
            const testUrls = [
                'http://localhost:3002?roomId=test123',
                'https://video-translate-app.vercel.app/?roomId=test123',
                'http://localhost:3002',
                'https://video-translate-app.vercel.app/',
                'http://localhost:3002?roomId=test123&other=param',
                'http://localhost:3002?other=param&roomId=test123'
            ];
            
            testUrls.forEach((url, index) => {
                const urlObj = new URL(url);
                const params = new URLSearchParams(urlObj.search);
                const roomId = params.get('roomId');
                
                log('urlParsingTest', `Teste ${index + 1}:`);
                log('urlParsingTest', `  URL: ${url}`);
                log('urlParsingTest', `  Room ID: ${roomId || 'Nenhum'}`);
                log('urlParsingTest', '');
            });
            
            log('urlParsingTest', '‚úÖ Teste de parsing conclu√≠do');
        }

        function simulateRealScenario() {
            clearLog('realScenarioTest');
            log('realScenarioTest', 'üß™ Simulando cen√°rio real...');
            
            // Simula o que acontece quando dois usu√°rios acessam
            const baseRoomId = 'test-room-123';
            
            log('realScenarioTest', `Cen√°rio: Dois usu√°rios acessando a mesma sala`);
            log('realScenarioTest', `Room ID base: ${baseRoomId}`);
            log('realScenarioTest', '');
            
            // Usu√°rio 1
            log('realScenarioTest', 'üë§ Usu√°rio 1 (Alice):');
            const user1Id = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            log('realScenarioTest', `  User ID: ${user1Id}`);
            log('realScenarioTest', `  Room ID: ${baseRoomId}`);
            log('realScenarioTest', `  Evento: join-room { roomId: "${baseRoomId}", user: { id: "${user1Id}", name: "Alice" } }`);
            log('realScenarioTest', '');
            
            // Pequeno delay para simular diferen√ßa de tempo
            setTimeout(() => {
                // Usu√°rio 2
                log('realScenarioTest', 'üë§ Usu√°rio 2 (Bob):');
                const user2Id = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                log('realScenarioTest', `  User ID: ${user2Id}`);
                log('realScenarioTest', `  Room ID: ${baseRoomId}`);
                log('realScenarioTest', `  Evento: join-room { roomId: "${baseRoomId}", user: { id: "${user2Id}", name: "Bob" } }`);
                log('realScenarioTest', '');
                
                // An√°lise
                log('realScenarioTest', 'üîç An√°lise:');
                log('realScenarioTest', `  ‚úÖ Room ID √© o mesmo: ${baseRoomId}`);
                log('realScenarioTest', `  ‚úÖ User IDs s√£o √∫nicos: ${user1Id !== user2Id}`);
                log('realScenarioTest', `  ‚úÖ Formato dos eventos est√° correto`);
                log('realScenarioTest', '');
                log('realScenarioTest', 'ü§î Se os usu√°rios est√£o em salas separadas, o problema pode estar:');
                log('realScenarioTest', '  1. No backend n√£o processando corretamente o join-room');
                log('realScenarioTest', '  2. Na l√≥gica de Socket.IO rooms');
                log('realScenarioTest', '  3. Na sincroniza√ß√£o de estado entre frontend e backend');
                
                updatePossibleCauses([
                    'Room ID est√° sendo gerado corretamente',
                    'User IDs s√£o √∫nicos',
                    'Formato dos eventos est√° correto',
                    'Problema pode estar no backend ou Socket.IO'
                ]);
            }, 100);
        }

        function testBackendConnection() {
            clearLog('backendTest');
            log('backendTest', 'üß™ Testando conex√£o com backend...');
            
            const isLocal = window.location.hostname === 'localhost';
            const backendUrl = isLocal ? 'http://localhost:3001' : 'https://video-translate-app.onrender.com';
            
            log('backendTest', `Ambiente: ${isLocal ? 'Local' : 'Produ√ß√£o'}`);
            log('backendTest', `Backend URL: ${backendUrl}`);
            log('backendTest', '');
            
            // Teste de health check
            fetch(`${backendUrl}/api/health`)
                .then(response => {
                    log('backendTest', `‚úÖ Health check: ${response.status} ${response.statusText}`);
                    return response.json();
                })
                .then(data => {
                    log('backendTest', `üìä Health data: ${JSON.stringify(data)}`);
                    log('backendTest', '');
                    
                    // Teste de Socket.IO
                    log('backendTest', 'üîå Testando Socket.IO...');
                    
                    // Simula conex√£o Socket.IO
                    const socketUrl = `${backendUrl}`;
                    log('backendTest', `Socket URL: ${socketUrl}`);
                    log('backendTest', 'Nota: Para teste completo, abra o console do navegador');
                    
                    updatePossibleCauses([
                        'Backend est√° respondendo corretamente',
                        'Health check funcionando',
                        'Socket.IO endpoint dispon√≠vel'
                    ]);
                })
                .catch(error => {
                    log('backendTest', `‚ùå Erro na conex√£o: ${error.message}`);
                    updatePossibleCauses([
                        'Problema de conectividade com backend',
                        'Backend pode estar offline',
                        'CORS ou firewall bloqueando conex√£o'
                    ]);
                });
        }

        function runCompleteTest() {
            clearLog('completeTest');
            log('completeTest', 'üöÄ Executando teste completo...');
            
            // Executa todos os testes em sequ√™ncia
            setTimeout(() => {
                log('completeTest', '1/4 Testando gera√ß√£o de Room ID...');
                testRoomIdGeneration();
            }, 500);
            
            setTimeout(() => {
                log('completeTest', '2/4 Testando parsing de URL...');
                testUrlParsing();
            }, 1000);
            
            setTimeout(() => {
                log('completeTest', '3/4 Simulando cen√°rio real...');
                simulateRealScenario();
            }, 1500);
            
            setTimeout(() => {
                log('completeTest', '4/4 Testando conex√£o backend...');
                testBackendConnection();
            }, 2000);
            
            setTimeout(() => {
                log('completeTest', '');
                log('completeTest', '‚úÖ Teste completo finalizado!');
                log('completeTest', 'üìã Verifique os resultados em cada se√ß√£o acima.');
                log('completeTest', 'üîç Poss√≠veis causas listadas na se√ß√£o "Poss√≠veis Causas Identificadas"');
                
                showSolution();
            }, 3000);
        }

        function updatePossibleCauses(causes) {
            const list = document.getElementById('possibleCauses');
            list.innerHTML = causes.map(cause => `<li>${cause}</li>`).join('');
        }

        function showSolution() {
            const solutionDiv = document.getElementById('solution');
            const solutionText = document.getElementById('solutionText');
            
            solutionText.innerHTML = `
                <h4>üîß Pr√≥ximos Passos Recomendados:</h4>
                <ol>
                    <li><strong>Verificar logs do backend:</strong> Abrir duas abas da aplica√ß√£o e verificar se o backend est√° recebendo os eventos join-room corretamente</li>
                    <li><strong>Verificar logs do frontend:</strong> Abrir o console do navegador e procurar por logs [TEST-LOG] para ver o fluxo de conex√£o</li>
                    <li><strong>Testar com Room ID fixo:</strong> Usar um Room ID fixo (ex: "test-123") em ambas as abas para eliminar variabilidade</li>
                    <li><strong>Verificar Socket.IO rooms:</strong> Confirmar se o backend est√° adicionando usu√°rios √† mesma room do Socket.IO</li>
                </ol>
                
                <h4>üéØ Teste Pr√°tico:</h4>
                <p>Abra duas abas com estas URLs:</p>
                <ul>
                    <li><code>${window.location.origin}?roomId=debug-test-123</code></li>
                    <li><code>${window.location.origin}?roomId=debug-test-123</code></li>
                </ul>
                <p>Use nomes diferentes (ex: "Alice" e "Bob") e verifique se o contador de participantes mostra "2" em ambas as abas.</p>
            `;
            
            solutionDiv.style.display = 'block';
        }

        // Executa teste inicial ao carregar
        window.onload = function() {
            log('completeTest', 'üîç P√°gina de debug carregada');
            log('completeTest', 'üìù Clique nos bot√µes acima para executar testes espec√≠ficos');
            log('completeTest', 'üöÄ Ou clique em "Executar Teste Completo" para executar todos');
        };
    </script>
</body>
</html>